version: '3.8'
env_file:
  - .env.dev

services:
  mongoDb:
    image: mongo:latest
    container_name: mongoDb
    volumes:
      - ./mongo-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}

  redis:
    image: redis:7.2-alpine
    container_name: redis
    volumes:
      - ./redis_data:/data
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    restart: unless-stopped

  emailServer:
    build:
      context: ./emailServer
      dockerfile: Dockerfile
    environment:
      - MY_EMAIL=${MY_EMAIL}
      - MY_PASSWORD=${MY_PASSWORD}
      - QUEUE_HOST=redis
      - QUEUE_PORT=6379
      - QUEUE_USER=default
      - QUEUE_PASSWORD=${QUEUE_PASSWORD}
    depends_on:
      - redis

  api-server:
    build:
      context: ./scsApiServer
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - MONGO_URI=${MONGO_URI:-"mongodb://root:${MONGO_INITDB_ROOT_PASSWORD}@mongoDb:27017/scsCloudDB"}

      - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}
      - OTP_SECRET=${OTP_SECRET}
      - ACCESS_KEY_CREDENTIALS_SECRET=${ACCESS_KEY_CREDENTIALS_SECRET}
      - SECRET_ACCESS_KEY_CREDENTIALS_SECRET=${SECRET_ACCESS_KEY_CREDENTIALS_SECRET}

      - ACCESS_KEY_ID=${ACCESS_KEY_ID}
      - SECRET_ACCESS_KEY=${SECRET_ACCESS_KEY}
      - MY_BUCKET_NAME=${MY_BUCKET_NAME}
      - BUCKET_HOST_FOR_HOSTING=${BUCKET_HOST_FOR_HOSTING}
      - HOSTING_DOMAIN=${HOSTING_DOMAIN}

      - CLUSTER_ARN=${CLUSTER_ARN}
      - TRANSCODER_TASK_DEFINITION_ARN=${TRANSCODER_TASK_DEFINITION_ARN}
      - HOSTER_TASK_DEFINITION_ARN=${HOSTER_TASK_DEFINITION_ARN}
      - TRANSCODER_TASK_NAME=${TRANSCODER_TASK_NAME}
      - HOSTER_TASK_NAME=${HOSTER_TASK_NAME}

      - MY_SUBNET_1=${MY_SUBNET_1}
      - MY_SUBNET_2=${MY_SUBNET_2}
      - MY_SUBNET_3=${MY_SUBNET_3}
      - MY_SECURITY_GROUP=${MY_SECURITY_GROUP}

      - QUEUE_HOST=redis
      - QUEUE_USER=default
      - QUEUE_PASSWORD=${QUEUE_PASSWORD}
      - QUEUE_PORT=6379

      - CASHFREE_APP_KEY=${CASHFREE_APP_KEY}
      - CASHFREE_APP_SECRET_KEY=${CASHFREE_APP_SECRET_KEY}

      - TRANSCODER_SERVICE_CHARGE=${TRANSCODER_SERVICE_CHARGE:-0}
      - HOSTING_SERVICE_CHARGE_PER_30_DAYS=${HOSTING_SERVICE_CHARGE_PER_30_DAYS:-0}

      - CLIENT_ORIGIN=${CLIENT_ORIGIN:-http://localhost:5173}

    depends_on:
      - mongoDb
      - redis
